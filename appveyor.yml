version: '{branch}.{build}'
skip_tags: true
image:
  - Visual Studio 2017
  - Visual Studio 2019
platform:
  - Win32
  - x64
configuration:
  - Debug
  - Release
matrix:
  exclude:
    - image: Visual Studio 2017
      configuration: Release
  skip_commits:
    files:
      - contrib/
      - doc/
      - Languages/
      - '*.txt'
      - '*.md'
      - src/*.txt
      - .tgitconfig
      - .mailmap
      - '**/.editorconfig'
      - '**/.clang.format'
init:
- git version
build_script:
- git submodule update --init -- ext/googletest ext/libgit2 ext/simpleini ext/tgit ext/zlib ext/pcre2
- cd ext\libgit2
- git config --global user.email "dummy@example.com"
- git config --global user.name "Dummy Name"
- for %%G in (..\libgit2-*.patch) do ( type %%G | git am )
- git config --unset --global user.email
- git config --unset --global user.name
- cd ..\..
- msbuild "src\TortoiseGit.sln" /t:"test\UnitTests" /m /verbosity:minimal /p:Configuration=%CONFIGURATION% /p:Platform=%PLATFORM% /maxcpucount /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

for:
  -
    matrix:
      only:
        - platform: Win32
          configuration: Debug
          image: Visual Studio 2017
    test_script:
    - set PATH="C:\Program Files\Git\mingw64\bin";%PATH%
  -
    matrix:
      only:
        - platform: x64
          configuration: Debug
          image: Visual Studio 2017
    test_script:
    - set PATH="C:\Program Files\Git\mingw64\bin";%PATH%
  -
    matrix:
      only:
        - platform: Win32
          configuration: Debug
          image: Visual Studio 2019
    test_script:
    - set PATH="C:\Program Files\Git\mingw64\bin";%PATH%
  -
    matrix:
      only:
        - platform: x64
          configuration: Debug
          image: Visual Studio 2019
    test_script:
    - set PATH="C:\Program Files\Git\mingw64\bin";%PATH%
  -
    matrix:
      only:
        - platform: Win32
          configuration: Release
          image: Visual Studio 2019
    test_script:
    - set PATH="C:\Program Files\Git\mingw64\bin";%PATH%
    - bin\Release\bin\tests.exe
  -
    matrix:
      only:
        - platform: x64
          configuration: Release
          image: Visual Studio 2019
    test_script:
    - set PATH="C:\Program Files\Git\mingw64\bin";%PATH%
